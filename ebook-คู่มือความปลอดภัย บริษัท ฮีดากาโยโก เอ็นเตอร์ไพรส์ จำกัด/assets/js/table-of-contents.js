/**
 * table-of-contents.js
 * ฟังก์ชันสำหรับเพิ่มลิงก์ในหน้าสารบัญ
 */

(function ($) {
  'use strict';

  // ฟังก์ชันสำหรับเพิ่มลิงก์ในหน้าสารบัญ
  function initTableOfContents() {
    // สมมติว่าหน้าสารบัญอยู่ที่หน้า 2-3 (อาจต้องปรับตามเอกสารจริง)
    var tocPages = [1,4,5,6,7]; // หมายเลขหน้าสารบัญ (สามารถปรับเปลี่ยนได้)

    // กำหนด clickable areas บนหน้าสารบัญ
    var tocLinks = [
      // ตัวอย่างการกำหนดพื้นที่คลิก: [หน้าที่มีสารบัญ, บทความที่จะไป, พิกัด x เริ่มต้น, พิกัด y เริ่มต้น, ความกว้าง, ความสูง]
      // [หน้าสารบัญ, หน้าปลายทาง, x, y, width, height]
      [1, 'https://www.hidakayookoo.co.th', 30, 94, 40, 5.5],   // บทที่ 1 ไปยังหน้า 5

      [4, 1, 10, 32, 80, 5.5],   // บทที่ 1 ไปยังหน้า 5
      [4, 3, 10, 38, 80, 6.5],   // บทที่ 1 ไปยังหน้า 5
      [4, 15, 10, 45, 80, 6.5],   // บทที่ 1 ไปยังหน้า 5
      [4, 19, 10, 52, 80, 6.5],   // บทที่ 1 ไปยังหน้า 5
      [4, 27, 10, 59, 80, 7],   // บทที่ 1 ไปยังหน้า 5
      [4, 31, 10, 66, 80, 6.5],   // บทที่ 1 ไปยังหน้า 5
      [4, 35, 10, 73, 80, 3.5],   // บทที่ 1 ไปยังหน้า 5
      [4, 49, 10, 76.5, 80, 3.5],   // บทที่ 1 ไปยังหน้า 5
      [4, 51, 10, 80, 80, 4],   // บทที่ 1 ไปยังหน้า 5
      [4, 54, 10, 84, 80, 4],   // บทที่ 1 ไปยังหน้า 5
      [4, 60, 10, 88, 80, 4.5],   // บทที่ 1 ไปยังหน้า 5
      
      [5, 61, 10, 32, 80, 4.5],   // บทที่ 1 ไปยังหน้า 5
      [5, 62, 10, 36.5, 80, 4],   // บทที่ 1 ไปยังหน้า 5
      [5, 63, 10, 40.5, 80, 3.5],   // บทที่ 1 ไปยังหน้า 5
      [5, 64, 10, 44, 80, 4],   // บทที่ 1 ไปยังหน้า 5
      [5, 65, 10, 48, 80, 3.8],   // บทที่ 1 ไปยังหน้า 5
      [5, 67, 10, 52, 80, 3.5],   // บทที่ 1 ไปยังหน้า 5
      [5, 68, 10, 55.7, 80, 4],   // บทที่ 1 ไปยังหน้า 5
      [5, 69, 10, 60, 80, 4],   // บทที่ 1 ไปยังหน้า 5
      [5, 71, 10, 64, 80, 5.8],   // บทที่ 1 ไปยังหน้า 5
      [5, 73, 10, 70, 80, 3.8],   // บทที่ 1 ไปยังหน้า 5
      [5, 75, 10, 74, 80, 3.8],   // บทที่ 1 ไปยังหน้า 5
      [5, 78, 10, 78, 80, 3.5],   // บทที่ 1 ไปยังหน้า 5
      [5, 83, 10, 81.5, 80, 3.5],   // บทที่ 1 ไปยังหน้า 5
      [5, 87, 10, 85, 80, 4],   // บทที่ 1 ไปยังหน้า 5
      [5, 89, 10, 89, 80, 3.5],   // บทที่ 1 ไปยังหน้า 5

      [6, 91, 10, 34.5, 80, 3.5],   // บทที่ 1 ไปยังหน้า 5
      [6, 93, 10, 38, 80, 4],   // บทที่ 1 ไปยังหน้า 5
      [6, 97, 10, 42, 80, 4],   // บทที่ 1 ไปยังหน้า 5
      [6, 99, 10, 46, 80, 3.5],   // บทที่ 1 ไปยังหน้า 5
      [6, 101, 10, 49.5, 80, 3.7],   // บทที่ 1 ไปยังหน้า 5
      [6, 103, 10, 53.5, 80, 3.4],   // บทที่ 1 ไปยังหน้า 5
      [6, 105, 10, 57, 80, 3.4],   // บทที่ 1 ไปยังหน้า 5
      [6, 107, 10, 60.5, 80, 3.4],   // บทที่ 1 ไปยังหน้า 5
      [6, 111, 10, 64, 80, 3.4],   // บทที่ 1 ไปยังหน้า 5
      [6, 115, 10, 67.5, 80, 3.4],   // บทที่ 1 ไปยังหน้า 5
      [6, 119, 10, 71, 80, 3.2],   // บทที่ 1 ไปยังหน้า 5
      [6, 123, 10, 74.5, 80, 3.2],   // บทที่ 1 ไปยังหน้า 5
      [6, 125, 10, 78, 80, 3.2],   // บทที่ 1 ไปยังหน้า 5
      [6, 132, 10, 81.5, 80, 3.2],   // บทที่ 1 ไปยังหน้า 5

      [7, 135, 10, 34.5, 80, 3.7],   // บทที่ 1 ไปยังหน้า 5
      [7, 137, 10, 38.3, 80, 3.7],   // บทที่ 1 ไปยังหน้า 5
      [7, 139, 10, 42.3, 80, 3.7],   // บทที่ 1 ไปยังหน้า 5
      [7, 141, 10, 46.3, 80, 3.5],   // บทที่ 1 ไปยังหน้า 5
      [7, 143, 10, 50, 80, 3.2],   // บทที่ 1 ไปยังหน้า 5
      [7, 145, 10, 53.5, 80, 3.2],   // บทที่ 1 ไปยังหน้า 5
      [7, 146, 10, 57, 80, 3.2],   // บทที่ 1 ไปยังหน้า 5
      [7, 147, 10, 60.5, 80, 3.2],   // บทที่ 1 ไปยังหน้า 5
      [7, 156, 10, 64, 80, 3.2],   // บทที่ 1 ไปยังหน้า 5
      [7, 157, 10, 67.5, 80, 3.4],   // บทที่ 1 ไปยังหน้า 5
      [7, 158, 10, 71, 80, 3.4],   // บทที่ 1 ไปยังหน้า 5
      [7, 159, 10, 74.5, 80, 3.2],   // บทที่ 1 ไปยังหน้า 5
      [7, 160, 10, 78, 80, 3.2],   // บทที่ 1 ไปยังหน้า 5
      // เพิ่มรายการเพิ่มเติมตามต้องการ
    ];

    // สไตล์สำหรับพื้นที่คลิก
    var linkStyle = {
      'position': 'absolute',
      'cursor': 'pointer',
      'z-index': 10,
      'background-color': 'rgba(0,0,0,0.0)', // โปร่งใส
      // 'border': '1px solid rgba(0,0,0,1)', // เส้นขอบบางๆ ช่วยให้เห็นพื้นที่
      'border-radius': '4px'
    };

    // เพิ่มพื้นที่คลิกไปยังหน้าสารบัญ
    function createTocLinks() {
      // ลบลิงก์เก่าทั้งหมด (ถ้ามี)
      $('.toc-link-area').remove();

      // สร้างลิงก์ใหม่
      tocLinks.forEach(function (link) {
        var tocPage = link[0];
        var targetPage = link[1];
        var x = link[2];
        var y = link[3];
        var width = link[4];
        var height = link[5];

        // ตรวจสอบว่าหน้าสารบัญมีอยู่จริงหรือไม่
        var $pageWrapper = $('.page-wrapper[page="' + tocPage + '"]');
        if ($pageWrapper.length === 0) {
          return; // ข้ามหากไม่พบหน้า
        }

        // สร้างพื้นที่คลิก
        var $linkArea = $('<div>')
          .addClass('toc-link-area') // เพิ่มคลาสเพื่อให้ง่ายต่อการลบ
          .css(Object.assign({}, linkStyle, {
            'left': x + '%',
            'top': y + '%',
            'width': width + '%',
            'height': height + '%'
          }))
          .attr('title', 'ไปที่หน้า ' + link[1]);

        // เพิ่ม hover effect เมื่อเมาส์ชี้
        $linkArea.hover(
          function () {
            $(this).css('background-color', 'rgba(0,0,255,0.1)'); // เมื่อ hover จะเห็นสีน้ำเงินอ่อนๆ
          },
          function () {
            $(this).css('background-color', 'rgba(0,0,0,0.0)'); // กลับเป็นโปร่งใส
          }
        );

        // ฟังก์ชันจัดการการคลิก/แตะ
        function handleLinkClick(e) {
          e.preventDefault();
          e.stopPropagation();

          if (typeof targetPage === 'string' && targetPage.startsWith('http')) {
            // open external link in new tab
            window.open(targetPage, '_blank');
            return false;
          }

          var flipbook = $('.ui-flipbook');
          if (flipbook.turn) {
            flipbook.turn('page', +targetPage + 7);
            // เล่นเสียงเปลี่ยนหน้า
            if (window.playPageFlipSound) {
              window.playPageFlipSound();
            }
          }

          return false;
        }

        // เพิ่ม event listeners สำหรับทั้ง desktop และ mobile
        $linkArea.on('click tap touchend', handleLinkClick);
        
        // เพิ่ม touch events สำหรับมือถือโดยเฉพาะ
        $linkArea[0].addEventListener('touchstart', function(e) {
          e.preventDefault();
          handleLinkClick(e);
        }, { passive: false });
        
        // $linkArea[0].addEventListener('touchend', function(e) {
        //   // e.preventDefault();
        //   // handleLinkClick(e);
        // }, { passive: false });

        // เพิ่มพื้นที่คลิกไปยังหน้าสารบัญ
        $pageWrapper.find('.page').append($linkArea);
      });

      console.log('Created TOC links');
    }

    // ตรวจสอบว่า Turn.js โหลดเสร็จหรือยัง
    function checkFlipbookReady() {
      var flipbook = $('.ui-flipbook');

      if (flipbook.length > 0 && typeof flipbook.turn === 'function') {
        // รับฟังเหตุการณ์ turned
        flipbook.bind('turned', function (event, page, view) {
          // ตรวจสอบว่าหน้าปัจจุบันเป็นหน้าสารบัญหรือไม่
          if (tocPages.indexOf(page) !== -1 ||
            (view && (tocPages.indexOf(view[0]) !== -1 || tocPages.indexOf(view[1]) !== -1))) {
            // เพิ่มลิงก์สำหรับหน้าสารบัญ
            setTimeout(createTocLinks, 100);
          }
        });

        // ใส่ลิงก์ตั้งแต่เริ่มต้น
        setTimeout(createTocLinks, 500);

        return;
      }

      // ถ้ายังไม่พร้อม ลองอีกครั้งในอีก 500ms
      setTimeout(checkFlipbookReady, 500);
    }

    // เริ่มการตรวจสอบ
    checkFlipbookReady();
  }

  // เริ่มต้นทำงานเมื่อ document พร้อม
  $(document).ready(function () {
    initTableOfContents();
  });

})(jQuery);